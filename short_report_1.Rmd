---
title: "Short Report 1"
author: "Kunwu Lyu"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(GGally)
library(broom)
library(patchwork)
```

## Data Wrangling
```{r}
#first spotify data, with crossover variable
#BE SURE TO DELETE THE LINE BREAK BEFORE RUNNING THIS
spotify_data_crossover <- read.csv(file = "https://www.math.carleton.edu/ckelling/regression/report_cross_spotify_data.csv") %>% 
  mutate(mode = as.factor(mode),
         key = as.factor(key),
         crossover_categ = as.factor(crossover_categ))


#second spotify dataset- all data, crossover labelled or not
#BE SURE TO DELETE THE LINE BREAK BEFORE RUNNING THIS
full_musc_data <- read.csv(file = "https://www.math.carleton.edu/ckelling/regression/report_nocross_spotify_data.csv") %>% 
  mutate(mode = as.factor(mode),
         key = as.factor(key))


#subset to just a few artists
# spotify_data_subset <- spotify_data_crossover %>%
#   filter(artist_name %in% c(artist, names, here))

glimpse(full_musc_data)

```



## EDA
```{r}
affective_musc_lm <- lm(valence ~ danceability*energy, data = full_musc_data)
summary(affective_musc_lm)

ggpairs(full_musc_data, columns = c("mode", "tempo", "valence"))

ggpairs(full_musc_data, columns = c("energy", "loudness", "danceability")) ->
  mtrx_plot
ggsave("matrix_plot.png", plot = mtrx_plot)

live_musc_lm <- lm(liveness ~ loudness+tempo+instrumentalness+valence, data = full_musc_data)
summary(live_musc_lm)

ggpairs(full_musc_data, columns = c("loudness", "tempo", "instrumentalness", "valence", "liveness"))

```

```{r}
# add something here

c("Gladys Knight & The Pips", "Stevie Wonder", "The Temptations") -> artists
# SLR

spotify_data_crossover_filtered <- spotify_data_crossover %>% 
  filter(artist_name %in% c("Gladys Knight & The Pips", "Stevie Wonder", "The Temptations"))

ggpairs(spotify_data_crossover_filtered, columns = c("energy", "loudness", "danceability"))

danceability_lm <- lm(danceability ~ loudness + energy * crossover_categ, data = spotify_data_crossover_filtered)
summary(danceability_lm)

danceability_lm_full2 <- lm(danceability ~ log(loudness+61) + log(energy+1)*crossover_categ, data = spotify_data_crossover_filtered)

danceability_lm <- danceability_lm_full2
# danceability_lm_full <- lm(danceability ~ energy + loudness + mode, data = full_musc_data %>% filter(artist_name %in% artists))
# summary(danceability_lm_full)

##### Assumptions

danceability_lm_aug <- augment(danceability_lm, data = spotify_data_crossover_filtered)

# residual plot
danceability_lm_res1 <- ggplot(danceability_lm_aug, aes(x = energy, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Energy (std)", y = "residuals",
       title = "Residual Plot")

danceability_lm_res2 <- ggplot(danceability_lm_aug, aes(x = loudness, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Loudness (dB)", y = "residuals",
       title = "Residual Plot")

danceability_lm_res3 <- ggplot(danceability_lm_aug, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Predicted Danceability", y = "residuals",
       title = "Residual Plot")

# normal qq plot
danceability_lm_qq <- ggplot(danceability_lm_aug, aes(sample = .resid))+
  geom_qq() +
  geom_qq_line() +
  labs(y = "Sample Quantiles", x = "Normal Quantiles")

combined_plot <- (danceability_lm_res1 | danceability_lm_res2) / (danceability_lm_res3 | danceability_lm_qq)
combined_plot + 
  plot_layout(guides = 'collect') + 
  plot_annotation(title = "Residual Plot and Normal Q-Q Plot of Spotify MLR")

ggplot(danceability_lm_aug, aes(x = artist_name, y = .resid)) +
  geom_boxplot() + 
  labs(y = "resid", x = "Artist")

# ggplot(danceability_lm_aug, aes(x = album_release_year, y = .resid)) +
#   geom_boxplot() + 
#   labs(y = "resid", x = "Year")
########FIX THIS LATER############

```

```{r}
# Vis

ggplot(data = spotify_data_crossover_filtered, aes(x = energy, y = danceability)) + 
  geom_point() + 
  facet_grid(cols = vars(crossover_categ)) +
  geom_smooth(method = "lm", se = T)

ggplot(data = spotify_data_crossover_filtered, aes(x = loudness, y = danceability)) + 
  geom_point() + 
  facet_grid(cols = vars(crossover_categ)) +
  geom_smooth(method = "lm", se = T)
```
```{r}
######## R^2 #########

danceability_lm_full <- danceability_lm
danceability_lm_red <- lm(danceability ~ loudness + energy, data = spotify_data_crossover_filtered)
danceability_lm_full2 <- lm(danceability ~ log(loudness+61) + log(energy+1)*crossover_categ, data = spotify_data_crossover_filtered)

anova(danceability_lm_full, danceability_lm_full2)
```

